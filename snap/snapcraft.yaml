name: rpcs3-emu
base: core20
version: 'latest'
summary: Open-source Sony PlayStation 3 Emulator
description: |
  RPCS3 is a multi-platform open-source Sony PlayStation 3 emulator and debugger written in C++ for Windows, Linux and BSD. 
  It was founded by programmers DH and Hykem. Initially hosted on Google Code, the project was eventually migrated to GitHub later on in its development. 
  RPCS3's first successful boots were primarily composed of small homebrew projects and hardware tests. 
  The emulator was later publicly released in June of 2012 and gained substantial attention from both the open-source community and PlayStation enthusiasts alike. 
  Today, RPCS3 is primarily developed by its two lead developers; Nekotekina, kd-11 and backed by flourishing team of GitHub contributors.
  --
  **Disclaimer:** This snap is not necessarily endorsed or officially maintained by the upstream developers.

  * Upstream Project: https://rpcs3.net/
  * snapcraft.yaml Build Definition: https://github.com/Nightmayr-snaps/rpcs3-snap/blob/master/snap/snapcraft.yaml

  Donate to rpcs3: https://www.patreon.com/Nekotekina
license: GPL-2.0
icon: snap/gui/rpcs3.png
grade: stable
confinement: strict
architectures:
  - build-on: amd64

package-repositories:
  - type: apt
    formats: [deb]
    components: [main]
    suites: [focal]
    # key-id: 0e383f7e
    key-id: 03F5D621A3710FA95A93D89BAA8452080E383F7E
    url: https://packages.lunarg.com/vulkan/1.2.148
  - type: apt
    ppa: beineri/opt-qt-5.14.2-focal

parts:
  rpcs3:
    source: https://github.com/RPCS3/rpcs3.git
    source-commit: 40558e7ac179789941ad4d6cc3546500add0ae97
    plugin: cmake
    build-snaps:
        - cmake
    # cmake-parameters: 
    # - -DCMAKE_BUILD_TYPE=Release
    # - 
    # cmake-generator: Ninja #Can be either Ninja or Unix Makefiles (default).
    # override-pull: |
    #   snapcraftctl pull
    #   git apply $SNAPCRAFT_STAGE/nodirtyversion.patch
    override-build: |
      # if [ ! -f /usr/bin/lsb_release ]; then
      #   apt install -y lsb-release
      # fi
      # pip3 install conan
      snapcraftctl build
      sed -i 's|Icon=rpcs3|Icon=/usr/local/share/icons/hicolor/scalable/apps/rpcs3.svg|' $SNAPCRAFT_PART_INSTALL/usr/local/share/applications/rpcs3.desktop
    build-packages:
    - build-essential
    - libasound2-dev 
    - libpulse-dev 
    - libopenal-dev 
    - libglew-dev 
    - zlib1g-dev 
    - libedit-dev 
    - libvulkan-dev 
    - libudev-dev 
    - git 
    - libevdev-dev
    - libsdl2-dev
    - vulkan-sdk
    # - vulkan-utils
    # - vulkan-tools
    - qt514-meta-minimal 
    - qt514svg
    stage-packages:
    - libsdl2-2.0-0
    - libasound2
    - qt5-gtk-platformtheme
    - libvulkan1
    - mesa-vulkan-drivers
    - vulkan-utils
    - vulkan-tools
    - libpulse0
    - libgl1-mesa-glx
    - mesa-utils
    - libglew2.1
    - libopengl0
    - libatomic1
    - libopenal1
    - libsndio7.0
    - qt514-meta-minimal 
    - qt514svg
    # - xdg-utils
  desktop-qt5:
    build-packages:
    - build-essential
    - qtbase5-dev
    - dpkg-dev
    make-parameters:
    - FLAVOR=qt5
    plugin: make
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: qt
    stage-packages:
    - libxkbcommon0
    - ttf-ubuntu-font-family
    - dmz-cursor-theme
    - light-themes
    - adwaita-icon-theme
    - gnome-themes-standard
    - shared-mime-info
    # - libqt5gui5
    - libgtk2.0-0
    - libgdk-pixbuf2.0-0
    # - libqt5svg5
    - libgpm2
    - freeglut3
    - libslang2
    - try:
      - appmenu-qt5
    - locales-all
    - qtwayland5
    - xdg-user-dirs
    override-prime: |
      snapcraftctl prime
      sed -i 's|XDG_DATA_HOME=$SNAP_USER_DATA|XDG_DATA_HOME=$SNAP_USER_COMMON|' $SNAPCRAFT_PRIME/bin/desktop-launch
      sed -i 's|XDG_CONFIG_HOME=$SNAP_USER_DATA|XDG_CONFIG_HOME=$SNAP_USER_COMMON|' $SNAPCRAFT_PRIME/bin/desktop-launch
    stage:
      - -usr/share/doc
  plasma-integration:
    plugin: nil
    stage-packages:
    - breeze-icon-theme
    - kde-style-breeze
    - plasma-integration
    stage:
    - -usr/share/doc
  # patches:
  #   plugin: dump
  #   source: snap/local/patches
  #   source-type: local
  #   prime:
  #     - -*
  launchers:
    plugin: dump
    source: snap/local/launchers
    source-type: local
    organize:
      '*': bin/

plugs:
  gtk-3-themes:
    interface: content
    target: $SNAP/data-dir/themes
    default-provider: gtk-common-themes
  icon-themes:
    interface: content
    target: $SNAP/data-dir/icons
    default-provider: gtk-common-themes
  sound-themes:
    interface: content
    target: $SNAP/data-dir/sounds
    default-provider: gtk-common-themes

layout:
  /usr/share/vulkan:
    symlink: $SNAP/usr/share/vulkan
  /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libvulkan_intel.so:
    symlink: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libvulkan_intel.so
  /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libvulkan_radeon.so:
    symlink: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libvulkan_radeon.so
  # /usr/share/qt5:
  #   symlink: $SNAP/usr/share/qt5

apps:
  rpcs3:
    command: usr/local/bin/rpcs3
    command-chain:
    - "bin/desktop-launch"
    - "bin/vulkan-icd-files"
    desktop: usr/local/share/applications/rpcs3.desktop
    environment:
      HOME: "$SNAP_USER_COMMON"
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/opt/qt514/lib:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pulseaudio"
      KDE_FORK_SLAVES: 1
      DISABLE_WAYLAND: 1
      PATH: "$PATH:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/libexec/kf5"
    plugs:
    - desktop
    - desktop-legacy
    - x11
    - wayland
    - audio-playback
    - opengl
    - joystick
    - unity7
    - network
    - network-bind
    - home
    - removable-media
    - gsettings
    - hardware-observe
    - mount-observe
    - bluez
    - browser-support
    - screen-inhibit-control

